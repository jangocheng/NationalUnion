@using NationalUnion.Application.Commons
@using NationalUnion.Web.HtmlHelpers
@{
    ViewBag.Title = "StatisticsList";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<table id="List">
    <div id="modalwindow" class="easyui-window" data-options="modal:true,closed:true,minimizable:false,shadow:false"></div>
    <div>
        <input id="txtStartTime" type="text" class="easyui-datebox" data-options="formatter:myformatter,parser:myparser" style="height: 22px; text-align: center; margin: 3px 5px 0 0; width: 140px;" />
        <input id="txtEndTime" type="text" class="easyui-datebox" data-options="formatter:myformatter,parser:myparser" style="height: 22px; text-align: center; margin: 3px 5px 0 0; width: 140px;" />
    </div>
    <div class="mvctool">
        <input id="txtQuery" type="text" value="输入*用户名*关键字" onfocus="if(value=='输入*用户名*关键字') {value='';}" onblur="if(value=='') {value='输入*用户名*关键字';}" style="text-align: center;" class="searchText">
        @Html.DropDownList("SharedPlatformStr", (List<SelectListItem>)ViewData["SharedPlatform"], new { style = "height:22px; float:left; margin: 3px 5px 0 0; width: 120px;" })
        @Html.DropDownList("SharedClientTypeStr", (List<SelectListItem>)ViewData["SharedClientType"], new { style = "height:22px; float:left; margin: 3px 5px 0 0; width: 120px;" })
        @Html.ToolButton("btnQuery", "icon-search", "查询", true)
    </div>
</table>

<script type="text/javascript">
    $(function () {
        $('#List').datagrid({
            url: '/ShareStatistics/GetStatisticsList',
            width: $(window).width() - 10,
            methord: 'post',
            height: $(window).height() - 60,
            fitColumns: true,
            sortName: 'SummaryDate',
            sortOrder: 'desc',
            idField: 'UserId',
            pageSize: 20,
            pageList: [10, 20, 30, 40, 50],
            pagination: true,
            striped: true,
            singleSelect: true,
            rownumbers: true,
            columns: [
                [
                    { field: 'UserId', title: '用户编号', width: 40 },
                    { field: 'UserName', title: '用户名', width: 40 },
                    { field: 'ChannelName', title: '渠道', width: 50 },
                    { field: 'PlatformName', title: '分享平台', width: 40 },
                    { field: 'SharedClientName', title: '分享途径', width: 40 },
                    { field: 'SharedQunatity', title: '分享量', width: 40, sortable: true },
                    { field: 'PV', title: 'PV', width: 40, sortable: true },
                    { field: 'UV', title: 'UV', width: 40, sortable: true },
                    { field: 'OrderQuantity', title: '订单数量', width: 40, sortable: true },
                    { field: 'ProductQuantity', title: '商品数量', width: 40, sortable: true },
                    { field: 'OrderAmount', title: '订单金额', width: 40, sortable: true },
                    { field: 'EstimateCommission', title: '预计佣金', width: 40, sortable: true },
                    { field: 'SummaryDate', title: '统计日期', width: 50, sortable: true }
                ]
            ]
        });
    });
</script>

<script type="text/javascript">
    function myformatter(date) {
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        var d = date.getDate();
        return y + '-' + (m < 10 ? ('0' + m) : m) + '-' + (d < 10 ? ('0' + d) : d);
    }
    function myparser(s) {
        if (!s) return new Date();
        var ss = (s.split('-'));
        var y = parseInt(ss[0], 10);
        var m = parseInt(ss[1], 10);
        var d = parseInt(ss[2], 10);
        if (!isNaN(y) && !isNaN(m) && !isNaN(d)) {
            return new Date(y, m - 1, d);
        } else {
            return new Date();
        }
    }

    // 设置初始值
    $(function () {
        var current = new Date();
        $("#txtStartTime").datebox("setValue", myformatter(current));
        $("#txtEndTime").datebox("setValue", myformatter(current));
    });

    function formatDate(date) {
        return date.getFullYear() + "-" + (date.getMonth()) + "-" + date.getDate();
    }
</script>

<script type="text/javascript">
    // 自动DataGrid，从第一次加载与重置窗体大小时候发生的事件：分部视图
    $(function () {
        $(window).resize(function () {
            $('#List').datagrid('resize', {
                width: $(window).width() - 10,
                height: $(window).height() - 60
            }).datagrid('resize', {
                width: $(window).width() - 10,
                height: $(window).height() - 60
            });
        });
    });
</script>

<script type="text/javascript">
    // iframe 返回
    function frameReturnByClose() {
        $("#modalwindow").window('close');
    }

    // iframe 返回并刷新
    function frameReturnByReload(flag) {
        if (flag)
            $("#List").datagrid('load');
        else
            $("#List").datagrid('reload');
    }

    // 输出信息
    function frameReturnByMes(mes) {
        $.messageBox5s('提示', mes);
    }

    // 生成唯一Guid
    function GetGuid() {
        var s4 = function () {
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        };
        return s4() + s4() + s4() + "-" + s4();
    }

    $(function () {
        $("#btnQuery").click(function () {
            var queryStr = $('#txtStartTime').datebox("getValue") + "/" + $('#txtEndTime').datebox("getValue") + "/" + $('#txtQuery').val() + "/" + $('#SharedPlatformStr').val() + "/" + $('#SharedClientTypeStr').val();
            $('#List').datagrid({ url: '/ShareStatistics/GetListByQuery?queryStr=' + encodeURI(queryStr) });
        });
    });
</script>
